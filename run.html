<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Pony IDE</title>
    <meta name="title" content="Pony IDE">
    <meta name="description" content="Create, Minify, Run, Debug and Share your Lua scripts for Stormworks: Build and Rescue. \nYou can also find tutorials, examples and documentation or use the ui builder for Lua without coding skills!">

    <!-- external libs -->
    <script src="scripts/lib/jquery.js" type="text/javascript"></script>
    <script src="scripts/lib/fengari_web.js" type="text/javascript" id="fengari-script" ></script>
    <script src="scripts/lib/fuse.js" type="text/javascript"></script>
    <script src="scripts/lib/vanilla_picker.js" type="text/javascript"></script>
    <script src="scripts/lib/signalr.js" type="text/javascript"></script>
    
    <script src="ace-builds/ace.js" type="text/javascript"></script>
    <script src="ace-builds/ext-language_tools.js" type="text/javascript"></script>
    
    <!-- my scripts -->
    <script src="src/scripts/loader.js" type="text/javascript"></script>
    <script src="src/scripts/lua_emulator.js" type="text/javascript"></script>
    <script src="src/scripts/stormworks_lua_api.js" type="text/javascript"></script>
    <script src="src/scripts/canvas.js" type="text/javascript"></script>
    <script src="src/scripts/map.js" type="text/javascript"></script>
    <script src="src/scripts/paint.js" type="text/javascript"></script>
    <script src="src/scripts/input.js" type="text/javascript"></script>
    <script src="src/scripts/output.js" type="text/javascript"></script>
    <script src="src/scripts/reporter.js" type="text/javascript"></script>
    <script src="src/scripts/share.js" type="text/javascript"></script>
    <script src="src/scripts/stormnet.js" type="text/javascript"></script>

    <style>
        @font-face {
            font-family: "Screen Mono";
            src: url("fonts/CG_pixel_4x5_mono.ttf");
        }
        canvas {
            image-rendering: pixelated;
        }
    </style>

    <!-- Simple run script -->
    <script type="text/javascript">
        
        // Shared code
        const id = 'X1qORUm3lD' // 'wzSGQ3dsy9';
        let code = null;
        let timer = null;

        // Mock storage
        STORAGE = {
            getConfiguration: key => {
                switch (key)  {
                    case 'settings.monitorRotation': return 0;
                    case 'settings.zoomfactor': return 4;
                    case 'settings.showOverflow': return false;      
                    case 'settings.monitorSize': return '9x5';    
                    case 'settings.touchscreenEnabled': return true;     
                    case 'settings.touchscreenSecondaryEnabled': return true;
                    case 'settings.inputTickDelay': return 0;
                    case 'inputs': return {
                            bools: {},
                            numbers: {}
                        }
                }
                console.error("getConfiguration missing key", key)
            },
            setConfiguration: (key, value) => {
            },
            setFromShare: (key, value) => {
                console.log('setFromShare', key, value)
                const settings = JSON.parse(value.settings)

                // Set code
                code = settings.editors.normal
                LOADER.done(LOADER.EVENT.STORAGE_READY)
            }
        }
        
        // Mock UI
        UI = {
            supportsTouch: () => {return true}
        }

        // Mock console
        CONSOLE = {
            print: msg => {
                console.log("from Lua print", msg)
            }
        }    

        UTIL = {
            alert: msg => {
                console.error("util alert", msg)
            }, 
            hintImportant: msg => {
                console.error("util hintImportant", msg)
            }
        }

        // Mock engine
        ENGINE = {
            init: () => {
                LOADER.done(LOADER.EVENT.ENGINE_READY)
            },
            isRunning: () => { return true },
            errorStop: () => {
                console.log('errorStop')
            }
        }
        LOADER.on(LOADER.EVENT.LUA_EMULATOR_READY, ENGINE.init);

        // Old loading indicator
        LOADER.on(LOADER.EVENT.PAGE_READY, ()=>{
            $('.ide').addClass('deactivated')
        })
        LOADER.onAllDone(()=>{
            $('.ide').removeClass('deactivated')
        })

        // Load code 
        function loadCode() {
            // Load code
            SHARE.doReceive(id, (success)=>{
                        if(success){
                            console.log('Shared code loaded')
                        } else {
                            console.error('Invalid key', id)
                        }
                    })
        }
        LOADER.on(LOADER.EVENT.CANVAS_READY, loadCode);


        // Tick
        function tick() {
            LUA_EMULATOR.tick()
            OUTPUT.refresh()
            CANVAS.reset()
            LUA_EMULATOR.draw()
        }

        // Run code
        function runCode() {
            CANVAS.reset()
            CANVAS.resetTouchpoints()
            MAP.reset()
            PAINT._reset()
            console.log('running code...')
            LUA_EMULATOR.load(code)
            INPUT.reset()
            OUTPUT.reset()

            // Run lua + update canvas
            timer = setInterval(tick, 16 * 1.1)
        }
        LOADER.on(LOADER.EVENT.STORAGE_READY, runCode);        
    </script>
</head>
<body>
    <div id="monitor">
        <canvas id="canvas"></canvas>
        <div id="overflow"></div>
    </div>    

    <!--
        INVISIBLE STUFF
    -->

    <div style="display: none;">
        <div id="monitor-container" viewable="viewable_monitor">
            <div class="monitor_info">
                <div>
                    <label>Width:</label>
                    <span class="width">0</span>
                </div>
                <div>
                    <label>Height:</label>
                    <span class="height">0</span>
                </div>
                <div>
                    <label>Zoom:</label><span class="zoom">3x</span>
                    <input type="range" min="1" max="10" id="zoomfactor" name="zoomfactor" value="1">
                </div>
            </div>
            <canvas id="render-canvas"></canvas>
            <canvas id="unzoomed-canvas"></canvas>
        </div>

        <div viewable="viewable_settings">
            <div class="setting">
                <label for="monitor-size">Monitor</label>
                <select id="monitor-size" name="monitor-size">
                    <option value="1x1">1x1</option>
                    <option value="2x1">2x1</option>
                    <option value="2x2">2x2</option>
                    <option value="3x1">3x1</option>
                    <option value="3x2">3x2</option>
                    <option value="3x3">3x3</option>
                    <option value="5x3">5x3</option>
                    <option value="9x5">9x5</option>
                </select>
            </div>
            <div class="setting">
                <label for="monitor-rotation">Rotate Monitor</label>
                <select id="monitor-rotation" name="monitor-rotation">
                    <option value="0">0째</option>
                    <option value="90">90째</option>
                    <option value="180">180째</option>
                    <option value="270">270째</option>
                </select>
            </div>
            <div class="setting">
                <label for="show-overflow">Show overflow</label>
                <input type="checkbox" id="show-overflow" name="show-overflow">
            </div>
            <div class="setting multi_setting" id="enable-touchscreen-container">
                <div>
                    <label for="enable-touchscreen">Enable Touchscreen</label>
                    <input type="checkbox" id="enable-touchscreen" name="enable-touchscreen" checked="true">
                </div>
                <div>
                    <label for="enable-touchscreen-secondary">Enable Secondary Input</label>
                    <input type="checkbox" id="enable-touchscreen-secondary" name="enable-touchscreen-secondary" checked="true">
                </div>
            </div>
        </div>      
    </div>

</body>
</html>
