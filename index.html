<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <title>Stormworks Lua</title>
    <meta name="title" content="Stormworks Lua">


    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#0194e2">
    <meta name="msapplication-TileColor" content="#0194e2">
    <meta name="theme-color" content="#0194e2">




    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="iconfont.css">
    <link rel="stylesheet" type="text/css" href="jquery_ui.css">

    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="jquery_ui.js"></script>
    <script type="text/javascript" id="fengari-script" src="fengari_web.js"></script>
    <script type="text/javascript" src="share.js"></script>
    <script type="text/javascript" src="script.js"></script>
    <script type="text/javascript" src="canvas.js"></script>
    <script type="text/javascript" src="paint.js"></script>
    <script type="text/javascript" src="map.js"></script>
    <script type="text/javascript" src="input.js"></script>
    <script type="text/javascript" src="output.js"></script>
    <script type="text/javascript" src="property.js"></script>
    <script type="text/javascript" src="stormworks_lua_api.js"></script>
    <script type="text/javascript" src="lua_emulator.js"></script>
    <script type="text/javascript" src="editor_autocompletition.js"></script>
    <script type="text/javascript" src="luaparse.js"></script>
    <script type="text/javascript" src="luamin.js"></script>


    <script type="text/javascript" src="version.js"></script>    
</head>
<body>
  <div class="background"></div>
  <div class="content">
    <div id="selection">
        <div id="logo"></div>
        <label for="monitor-size">Monitor</label>
        <select id="monitor-size" name="monitor-size">
            <option value="1x1">1x1</option>
            <option value="2x2">2x2</option>
            <option value="5x3">5x3</option>
            <option value="9x5">9x5</option>
        </select>
        <label for="show-overflow">Show overflow</label>
        <input type="checkbox" id="show-overflow" name="show-overflow" checked>
        <label for="enable-touchscreen">Enable Touchscreen</label>
        <input type="checkbox" id="enable-touchscreen" name="enable-touchscreen">
        <div class="time_between">
            <label>Time between ticks (ms): <span id="timeBetweenTicksVal">200 ms</span></label>
            <input type="range" min="20" max="2000" value="200" id="timeBetweenTicks">
        </div>
        <div class="time_between">
            <label>Time between draws (ms): <span id="timeBetweenDrawsVal">500 ms</span></label>
            <input type="range" min="50" max="5000" value="500" id="timeBetweenDraws">
            <span>Average time for a draw:<span id="drawtime">0 ms</span></span>
        </div>
        <div style="display: none" id="beta">Beta</div>
    </div>
    <div id="top">
        <div id="property" class="value_list"></div>
        <div id="input" class="value_list"></div>
        <div id="monitor">
            <canvas id="canvas"></canvas>
            <div id="overflow"></div>
            <div class="zoomfactor">
                <label for="zoomfactor">Monitor Zoom: <span>3x</span></label>
                <input type="range" min="1" max="4" id="zoomfactor" name="zoomfactor" value="1">
            </div>
        </div>
        <div id="output" class="value_list"></div>
    </div>
    <div id="editor">
        <div id="controls">
            <div class="controls_container">
                <button id="start">Start</button>
                <button id="stop">Stop</button>            
            </div>
            <div class="controls_container">
                <button id="reset">Reset all data</button>
            </div>
            <div class="controls_container">
                <button id="minify" style="margin-left: auto;">Minify (Beta)</button>
                <input type="checkbox" name="minify-identation" id="minify-identation" checked>
                <label>Line breaks</label>
            </div>
            <div class="controls_container">
                <div id="share" class="share">
                    <div class="docreate">
                        Share
                    </div>
                    <div class="more">
                        <div class="currentshare_container">
                            <input type="text" class="currentshare" name="currentshare"/>
                            <span class="copy_share_to_clipboard">Copy</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="code-container">
            <div id="code">
function onTick()
    -- Example that adds two composite channels together and outputs the result
    in1 = input.getNumber(1)
    in2 = input.getNumber(2)
    output.setNumber(1, in1 + in2)
end    
        
function onDraw()
    -- Example that draws a red circle in the center of the screen with a radius of 20 pixels
    width = screen.getWidth()
    height = screen.getHeight()
    screen.setColor(255, 0, 0)
    screen.drawCircleF(width / 2, height / 2, 20)
end
            </div>
            <div id="code-editor-information">
                <span id="selection-information">Line 0, Column 0, Char 0</span>
                <span id="autocompletition-hint">Use right click, Ctrl+Space or Command+Space to open the autocompletition menu</span>
                <span id="charactercount">0/4096</span>
            </div>
            <div id="code-lock"></div>
            <div id="autocompletition-container"></div>
        </div>
    </div>

    <div id="minified-code-container" class="container" style="display: none;">
        <h3>Minified Code:</h3>
        <div id="minified-code">
        </div>
        <div id="code-minified-editor-information">
            <span id="minified-charactercount">0/4096</span>
        </div>
    </div>

    <div id="out">
        <h3>Console Output:</h3>
        <textarea readonly id="console"></textarea>
    </div>
    <br>
    
    <div class="information_container">
        View the public source code of this page <a target="_blank" rel="noopener noreferrer" href="https://gitlab.com/stormworks-lua-editor/editor">here</a>
    </div>

    <div class="information_container">
        <h2>Lua manual:</h2>
        <p>
            <a href="https://www.lua.org/manual/5.3/" target="_blank" rel="noopener noreferrer">https://www.lua.org/manual/5.3/</a>
        </p>
    </div>

    <div id="documentation" class="information_container">
        <h2>Available functions:</h2>
    </div>

    <div id="touchscreen" class="information_container">
        <h2>Touchscreen</h2>
        <p>The composite output from the monitors contains data that can be interpreted in your script to create touchscreens. The layout of the composite data is as follows:</p>
        <span>Number Channels</span>
        <ol>
            <li>monitorResolutionX</li>
            <li>monitorResolutionY</li>
            <li>input1X</li>
            <li>input1Y</li>
            <li>input2X</li>
            <li>input2Y</li>            
        </ol>
        <span>On/Off Channels</span>
        <ol>
            <li>isInput1Pressed</li>
            <li>isInput2Pressed</li>
        </ol>
        <p>Hint: As long as an input is pressed the x and y coordinated will not change! This means you cannot implement drag functionality!</p>
    </div>

    <div id="libraries" class="information_container">
        <h2>Libraries</h2>
        <p>The following global lua functions are available:</p>
        <ul>
            <li>pairs</li>
            <li>ipairs</li>
            <li>next</li>
            <li>tostring</li>
            <li>tonumber</li>
        </ul>
        <p>and additional functions are available through the following lua libraries:</p>
        <ul>
            <li>math</li>
            <li>table</li>
            <li>string</li>
        </ul>
    </div>
    
    <div id="meta" class="information_container">
        <h2>Meta from the devs</h2>
        <p>This scripting API is very powerful and as such there are some important reminders to take note of:</p>
        <ul>
            <li>Your script has a max execution time of 1000 milliseconds, however it is still possible to create scripts that significantly slow down the game. It is your responsibility to ensure your script runs efficiently.</li>
            <li>Random number functions are provided by the Lua math library. Use of randomness in your scripts is likey to cause desync in multiplayer, so use these functions at your own risk</li>
            <li>When your vehicle despawns and respawns, your script will be executed 'fresh' and any state stored within the script will be lost. We recommend keeping your script as stateless as possible, and making use of existing logic components (e.g. memory register) to store values that you with to persist</li>
            <li>Your scripts run as a 'black box' with only the logic inputs/outputs being synced in multiplayer. Keep in mind that complex logic in your script may behave differently for different players in a multiplayer session.</li>
            <li>A number of safeguards are in place to sandbox your script, however it is still possible to write scripts that will potentially crash your game. If you crash your game with a script it's likely that you're doing something (very) wrong. This is your own responsibility. If you suspect you have encountered a legitimate bug, please report it on the Stormworks issue tracker (accessible from the pause-menu).</li>
            <li>Malicious and harmful scripts will not be tolerated on the Stormworks Steam Workshop</li>
        </ul>
        <p>Finally, enjoy the almost limitless possibilities that these scripts provide. This short wiki aims to give a good overview of how scripting in Stormworks works, however if you have any questions that are not covered here, please fell free to join us on Discord (accessible from the pause-menu)!</p>
    </div>


    <div id="fixed-information-badges">
        <div id="help-badge" class="hoverable">
            <div>
                <span class="icon-question"></span>
                <span class="heading">Help</span>
            </div>
        </div>
        <div>
            <span class="heading">Report a bug</span>
            <div class="discord"><img src="discord.png">CrazyFluffyPony#0587</div>
            <div class="email"><span class="icon-mail"></span><a href="mailto://crazyfluffypony@gmail.com">crazyfluffypony@gmail.com</a></div>            
        </div>
    </div>



    <script type="text/javascript">
        setTimeout(()=>{
          if(typeof window.version === 'string'){
            $('#information .version').attr('href', 'https://gitlab.com/stormworks-model-analyzer/analyzer/tags/v' + window.version);
            $('#information .version img').attr('src', 'https://img.shields.io/badge/version-' + window.version + '-%231182c3.svg');
          }
        }, 500)
    </script>

    <script src="ace-builds/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="ace-builds/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
    <script>
        var editor = ace.edit("code");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/lua");

        var minifiedEditor = ace.edit("minified-code");
        minifiedEditor.setTheme("ace/theme/monokai");
        minifiedEditor.session.setMode("ace/mode/lua");
    </script>

    <div id="help" style="display: none;">
        <div id="help-content">
            <span id="help-close" class="icon-cross"></span>
            <div class="section">
                <h3>Short introduction into the page:</h3>
                <div id="help-youtube-video">https://www.youtube.com/watch?v=hHgnNmwmZCY</div>
            </div>
            <div class="section">
                <h3>Lua</h3>
                <p>
                    You can find the complete documentation and some examples on the official lua website:
                    <a href="https://www.lua.org/manual/5.3/" target="_blank" rel="noopener noreferrer">https://www.lua.org/manual/5.3/</a>
                </p>
            </div>
            <div class="section">
                <h3>Monitor, Properties, Inputs, Outputs ...</h3>
                <br>
                <h4>Monitor</h5>
                <p>
                    You can select different monitor sizes. On zoom=1 one pixel of the monitor is exactly one pixel of your real monitor. You can zoom the monitor for easier development (this does not influence the screen.getHeight() in the lua script!).
                </p>
                <h4>Properties</h5>
                <p>
                    Like in the game you can set properties. Choose a property type, then write the label of the property into the input field of the property type you want. Depending on the type you can now set the value of the property: boolean, number or text.
                </p>
                <h4>Inputs</h5>
                <p>
                   The inputs simulate the lua scripts input composite. To write a value to the composite select the channel on the type of composite you want to have (boolean or number). Then You can enter the value for that channel.
                   <b>Numbers</b> have an additional settings button where you can switch between normal number input and slider. You can also activate the oscilate function for this input. Oscilate means the input value will change every tick by the set step. Once it reaches the upper or lower limit it will change direction.
                </p>
                <h4>Outputs</h5>
                <p>
                    This simulates the lua scripts output composite. When the lua script assigns values to the output, they will show up here.                    
                </p>
            </div>
            <div class="section">
                <h3>Code Editor</h3>
                <p>
                    The code editor has more functionality than you would expect. Most of them are similar to Sublime Text 3:
                    <ul>
                        <li>Multiselect (Hold ctrl and click)</li>
                        <li>Search and Replace (Ctrl + F, Ctrl + H)</li>
                        <li>Undo, Redo (Ctrl + Z, Ctrl + Y)</li>
                        <li>Autocompletition (Ctrl + Space)</li>
                    </ul>
                </p>
            </div>
            <div class="section">
                <h3>Minifying</h3>
                <p>
                    <b>This feature is work in progress!</b>                    
                    <br>
                    The more complicated your code is the higher is the risk of something not working after minifying it.
                    <br>
                    Always test your code after minifying it!
                    <br>
                    <br>
                    When your code is exceeding the maximum length allowed in Stormworks you have several options:
                    <ul>
                        <li>Edit the code manually and shorten variable names or function names</li>
                        <li>Split up your code into 2 or more parts which then run in different luascript components ingame</li>
                        <li>Click the minify button (for better reading you can check the option "Line breaks")</li>
                    </ul>
                    If you used the minify button then your minified code will appear below the original code.
                    You will propably see that the minified code has less characters then the original one.
                </p>
            </div>
            <div class="section">
                <h3>Sharing</h3>
                <p>Sharing your code with other people is pretty easy:
                    <ul>
                        <li>Write your code or paste it into the code editor</li>
                        <li>Adjust all the settings (monitor size, inputs, properties, time between draws) as you need them</li>
                        <li>Click the blueish share button and a url is generated</li>
                        <li>Send this url to other people</li>
                        <li>When they open the url they will see your code as well as all of your settings</li>
                    </ul>
                    <br>
                    <b>Hint: You cannot change anything you shared</b>
                    <br>
                    <i>(because we do not know if you are the owner of the code)</i>
                </p>
            </div>
        </div>
    </div>

    <img src="map_darker.png" id="map" style="display: none;">

    <div style="display: none" id="pastebin-create-overlay" class="pastebin_overlay">
        <div class="inner">
            <div class="circle">
                <p>Pushing code to pastebin<span dot="1">.</span><span dot="2">.</span><span dot="3">.</span></p>
            </div>
        </div>
    </div>
    <div style="display: none" id="pastebin-receive-overlay" class="pastebin_overlay">
        <div class="inner">
            <div class="circle">
                <p>Receiving code from pastebin<span dot="1">.</span><span dot="2">.</span><span dot="3">.</span></p>
            </div>
        </div>
    </div>
</body>
</html>