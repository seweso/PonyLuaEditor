<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 
        Features of this page (compared to IDE):
        - Full screen when rotated on iPhone
        - No scrolling or zooming (not even at the edges)
        - Full screen "monitor" div
        - Auto starts scripts
        - Does not show IDE warnings
    -->
    <meta charset="utf-8">

    <title>Pony Apps</title>
    <meta name="title" content="Pony Apps">
    <meta name="description" content="Runs Lua fullscreen Apps for Stormworks: Build and Rescue. \nUse your stormworks Lua knowledge to create apps to control your stormworks creations. ">

    <!-- external libs -->
    <script src="scripts/lib/jquery.js" type="text/javascript"></script>
    <script src="scripts/lib/fengari_web.js" type="text/javascript" id="fengari-script" ></script>
    <script src="scripts/lib/signalr.js" type="text/javascript"></script>
    
    <!-- my scripts -->
    <script src="src/scripts/loader.js" type="text/javascript"></script>
    <script src="src/scripts/lua_emulator.js" type="text/javascript"></script>
    <script src="src/scripts/stormworks_lua_api.js" type="text/javascript"></script>
    <script src="src/scripts/canvas.js" type="text/javascript"></script>
    <script src="src/scripts/map.js" type="text/javascript"></script>
    <script src="src/scripts/paint.js" type="text/javascript"></script>
    <script src="src/scripts/input.js" type="text/javascript"></script>
    <script src="src/scripts/output.js" type="text/javascript"></script>
    <script src="src/scripts/reporter.js" type="text/javascript"></script>
    <script src="src/scripts/share.js" type="text/javascript"></script>
    <script src="src/scripts/stormnet.js" type="text/javascript"></script>

    <style>
        @font-face {
            font-family: "Screen Mono";
            src: url("fonts/CG_pixel_4x5_mono.ttf");
        }
        body {
            background-color: black;
            height: 300vh;        
        }
        #monitor {
            position: fixed;
            
            top:0;
            left:0;
            right:0;
            bottom:0;
            /*padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);*/
            

            color:white;
            font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
            font-size: large;
        }
        canvas {
            image-rendering: pixelated;

            max-width: 100%;
            max-height: 100%;
            bottom: 0;
            left: 0;
            margin: auto;
            overflow: auto;
            position: absolute;
            right: 0;
            top: 0;
            -o-object-fit: contain;
            object-fit: contain;
            zoom: 900%
        }    
    </style>

    <!-- Simple run script -->
    <script type="text/javascript">
        
        // Get code id from url
        const urlParams = new URLSearchParams(window.location.search);
        let id = urlParams.get('id2'); // 'X1qORUm3lD' // 'wzSGQ3dsy9'; // TODO Use id instead of id2 (refactor share.js?)

        // Load documentation when no id is supplied
        if (!id) {
            id = "qjzIPO504r";

            // Set id in url
            urlParams.set('id2', id);
            let query = urlParams.toString()
            window.history.pushState(null, document.title, document.location.pathname + (query.length > 0 ? '?' + query : ''))      
        }

        let code = null;
        let timer = null;
        let monitorDiv = null;

        // Old loading indicator
        LOADER.on(LOADER.EVENT.PAGE_READY, ()=>{
            monitorDiv = document.querySelector("#monitor");
        })

        // Mock storage
        STORAGE = {
            getConfiguration: key => {
                // TODO: Only used for initial values
                switch (key)  {
                    case 'settings.monitorRotation': return 0; // TODO return monitorDiv.clientWidth < monitorDiv.clientHeight ? 90 : 0;
                    case 'settings.zoomfactor': return 10;
                    case 'settings.showOverflow': return false;      
                    case 'settings.monitorSize': return monitorDiv.clientWidth < monitorDiv.clientHeight ? '5x9' : '9x5';    
                    case 'settings.touchscreenEnabled': return true;     
                    case 'settings.touchscreenSecondaryEnabled': return true;
                    case 'settings.inputTickDelay': return 0;
                    case 'inputs': return {
                            bools: {},
                            numbers: {}
                        }
                }
                console.error("getConfiguration missing key", key)
            },
            setConfiguration: (key, value) => {
            },
            setFromShare: (key, value) => {
                console.log('setFromShare', key, value)
                const settings = JSON.parse(value.settings)

                // Set code
                code = settings.editors.normal
                LOADER.done(LOADER.EVENT.STORAGE_READY)
            }, 
            setConfigVal: (elem, confName, defaultValue) => {
                // TODO: Duplicate func 
                let v = STORAGE.getConfiguration(confName)
                v = ( v !== undefined && v !== null ) ? v : defaultValue 

                let oldV
                let setterFunc
                if(typeof defaultValue === 'boolean'){
                    oldV = elem.prop('checked')
                    setterFunc = (vv)=>{elem.prop('checked', vv)}
                } else {
                    oldV = elem.val()
                    setterFunc = (vv)=>{elem.val(vv)}
                }

                if (v != oldV) {
                    setterFunc(v)
                    elem.trigger('change')
                }                
            }
        }
        
        // Mock UI
        UI = {
            supportsTouch: () => {return true}
        }

        // Mock console
        CONSOLE = {
            print: msg => {
                console.log("from Lua print", msg)
            }
        }    

        UTIL = {
            alert: msg => {
                console.error("util alert", msg)
            }, 
            hintImportant: msg => {
                console.error("util hintImportant", msg)
            }
        }

        // Mock engine
        ENGINE = {
            init: () => {
                LOADER.done(LOADER.EVENT.ENGINE_READY)
            },
            isRunning: () => { return true },
            errorStop: () => {
                console.log('errorStop')
            }
        }
        LOADER.on(LOADER.EVENT.LUA_EMULATOR_READY, ENGINE.init);

        // Load code 
        function loadCode() {
            // Load code
            SHARE.doReceive(id, (success)=>{
                        if(success){
                            console.log('Shared code loaded')
                        } else {
                            console.error('Invalid key', id)
                        }
                    })
        }
        LOADER.on(LOADER.EVENT.CANVAS_READY, loadCode);
        
        // Tick
        function tick() {
            LUA_EMULATOR.tick()
            OUTPUT.refresh()
            CANVAS.reset()
            LUA_EMULATOR.draw()
        }

        function sizeChanged() {
            STORAGE.setConfigVal($('#monitor-size'), 'settings.monitorSize', '1x1')

            // Scroll down for full screen effect
            window.scrollBy(0, 100);
        }

        // Run code
        function runCode() {
            CANVAS.reset()
            CANVAS.resetTouchpoints()
            MAP.reset()
            PAINT._reset()
            console.log('running code...')
            LUA_EMULATOR.load(code)
            INPUT.reset()
            OUTPUT.reset()

            // Run lua + update canvas
            timer = setInterval(tick, 16 * 1.1)

            // Check monitor orientation
            new ResizeObserver(sizeChanged).observe(monitorDiv);
            //TODO window.onscroll = sizeChanged;
        }
        LOADER.on(LOADER.EVENT.STORAGE_READY, runCode);        
    </script>
</head>
<body>
    <div id="monitor">
        <canvas id="canvas"></canvas>
    </div>

    <!--
        INVISIBLE STUFF
    -->

    <div style="display: none;">
        <div id="monitor-container" viewable="viewable_monitor">
            <div class="monitor_info">
                <div>
                    <label>Width:</label>
                    <span class="width">0</span>
                </div>
                <div>
                    <label>Height:</label>
                    <span class="height">0</span>
                </div>
                <div>
                    <label>Zoom:</label><span class="zoom">3x</span>
                    <input type="range" min="1" max="10" id="zoomfactor" name="zoomfactor" value="1">
                </div>
            </div>
            <canvas id="render-canvas"></canvas>
            <canvas id="unzoomed-canvas"></canvas>
        </div>

        <div viewable="viewable_settings">
            <div class="setting">
                <label for="monitor-size">Monitor</label>
                <input type="text" id="monitor-size" name="monitor-size" value="9x5">
            </div>
            <div class="setting">
                <label for="monitor-rotation">Rotate Monitor</label>
                <select id="monitor-rotation" name="monitor-rotation">
                    <option value="0">0째</option>
                    <option value="90">90째</option>
                    <option value="180">180째</option>
                    <option value="270">270째</option>
                </select>
            </div>
            <div class="setting">
                <label for="show-overflow">Show overflow</label>
                <input type="checkbox" id="show-overflow" name="show-overflow">
            </div>
            <div class="setting multi_setting" id="enable-touchscreen-container">
                <div>
                    <label for="enable-touchscreen">Enable Touchscreen</label>
                    <input type="checkbox" id="enable-touchscreen" name="enable-touchscreen" checked="true">
                </div>
                <div>
                    <label for="enable-touchscreen-secondary">Enable Secondary Input</label>
                    <input type="checkbox" id="enable-touchscreen-secondary" name="enable-touchscreen-secondary" checked="true">
                </div>
            </div>
        </div>      
    </div>

</body>
</html>
